%==========================================================================
% 实验名称: DTMF 信号采集与量化误差分析
% 作者: Plsleep
% 日期: 2025年
% 描述: 本脚本模拟DTMF信号的生成、采样及量化过程，并重点分析
%       绝对误差与相对误差在时域上的分布特性。
%==========================================================================

clear all; clc; close all;

%--------------------------------------------------------------------------
% 1. 系统参数设置
%--------------------------------------------------------------------------
Fs = 8000;              % 采样频率 8000 Hz (标准电话语音采样率)
T = 1/Fs;               % 采样周期
Tp = 0.05;              % 观测时长，设置为50ms以便清晰观察波形细节
                        % 原指导书可能建议更长时间，但为了绘图清晰，取短时间窗口

%--------------------------------------------------------------------------
% 2. 模拟信号生成 (Analog Signal Simulation)
%--------------------------------------------------------------------------
% 为了在计算机中模拟"连续"信号，我们使用极高的时间分辨率
dt_analog = 0.00001;    % 模拟信号的时间步长 (100kHz 采样，远高于 Fs)
t = 0:dt_analog:Tp;     % 模拟时间轴

% 生成 DTMF 信号 (按键 '2': 697Hz + 1336Hz)
xa = sin(2*pi*697*t) + sin(2*pi*1336*t);

%--------------------------------------------------------------------------
% 3. 信号采样 (Sampling)
%--------------------------------------------------------------------------
n = 0:(Tp/T);           % 离散采样点的索引序列
x = sin(2*pi*697*n*T) + sin(2*pi*1336*n*T); % 理想采样信号

%--------------------------------------------------------------------------
% 4. 信号量化 (Quantization)
%--------------------------------------------------------------------------
% 设定量化阶距 delta。此处设为 0.5，这是一个非常粗糙的量化，
% 旨在放大并直观展示量化误差的效应。
deltax = 0.5;           

% 量化运算：先除以阶距，四舍五入取整，再乘以阶距
xq = round(x/deltax) * deltax; 

%--------------------------------------------------------------------------
% 5. 误差计算 (Error Analysis)
%--------------------------------------------------------------------------
% 绝对误差 (Absolute Error)
e = xq - x;             

% 相对误差 (Relative Error)
% 注意：此处使用点除./，且分母取绝对值。
% 潜在风险：当 x 接近 0 时，相对误差会趋向无穷大。
rerror = (xq - x)./ abs(x); 

%--------------------------------------------------------------------------
% 6. 结果可视化 (Visualization)
%--------------------------------------------------------------------------

% 图1: 模拟信号波形
figure(1);
plot(t, xa, 'LineWidth', 1.5);
title('图1: 模拟 DTMF 信号 x(t) [0-0.05s]');
xlabel('时间 t (s)'); ylabel('幅度');
grid on;
axis([0 0.02 -2.5 2.5]); % 局部放大观察前20ms

% 图2: 采样后的离散信号
figure(2);
stem(n, x, 'filled', 'MarkerSize', 4);
title('图2: 离散 DTMF 信号 x(n)');
xlabel('采样点数 n'); ylabel('幅度');
grid on;
axis([0 50 -2.5 2.5]);   % 观察前50个采样点

% 图3: 量化后的数字信号
figure(3);
stem(n, xq, 'filled', 'MarkerSize', 4, 'Color', 'r');
title('量化后的信号');
xlabel('采样点数 n'); ylabel('量化幅度');
grid on;
axis([0 50 -2.5 2.5]);

% 图4: 绝对量化误差
figure(4);
plot(n, e, 'o-', 'LineWidth', 1);
title('图4: 绝对量化误差 e(n)');
xlabel('采样点数 n'); ylabel('误差幅度');
grid on;
y_limit = deltax/2 + 0.1;
axis([0 50 -y_limit y_limit]); 
% 理论上绝对误差应被限制在 [-0.25, 0.25] 之间

% 图5: 相对量化误差
figure(5);
plot(n, rerror, '*r');
title('图5: 相对量化误差 r_{error}(n)');
xlabel('采样点数 n'); ylabel('相对误差');
grid on;
axis([0 50 -5 5]); 
% 注意观察图中的尖峰

% 图6: 误差对比分析
figure(6);
subplot(2,1,1);
stem(n, e, 'filled'); 
title('绝对误差分布'); grid on; axis([0 50 -0.5 0.5]);
subplot(2,1,2);
stem(n, rerror, 'filled', 'r'); 
title('相对误差分布'); grid on; axis([0 50 -10 10]);
